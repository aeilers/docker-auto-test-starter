#!/bin/bash

###
# environment install script for Alpine Linux on Docker
###
runInstall () {
    local DIVIDER="===================="
    local TEMPLATE="\n\n${DIVIDER}${DIVIDER}${DIVIDER}\n%s\n\n\n"

    ###
    # NOTE: setup script dependencies
    ###
    printf "${TEMPLATE}" "Installing supporting scripts"
    setupScripts
    baseInstall
    testInstall

    ###
    # NOTE: setup project
    ###
    projectInstall

    ###
    # NOTE: add additional file/folder removal here for all images
    ###
    clearApkCache

    # set permissions for node user group
    chgrp -R node .
    chmod -R g+w .
}

setupScripts () {
    apk add \
        ca-certificates \
        dumb-init \
        openssl
    update-ca-certificates

    mkdir -p /opt/scripts
    wget -qO- https://github.com/aeilers/docker-script-lib/archive/master.tar.gz | tar xzf - -C /opt/scripts
    cp -r /opt/scripts/docker-script-lib-master/* /opt/scripts/
    rm -r /opt/scripts/docker-script-lib-master/

    find /opt/scripts/ -mindepth 1 -maxdepth 1 -type d \
        -not -name base \
        -not -name nodejs \
        -not -name "test" \
        -not -name "." \
        -exec rm -rf {} \;

    chmod +x /opt/scripts/base/*
    ln -s /opt/scripts/base/* /usr/local/bin/

    chmod +x /opt/scripts/nodejs/*
    ln -s /opt/scripts/nodejs/* /usr/local/bin/

    chmod +x /opt/scripts/test/*
    ln -s /opt/scripts/test/* /usr/local/bin/
}

runInstall
